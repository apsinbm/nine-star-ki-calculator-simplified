/**
 * Calculator Component
 *
 * Main interactive calculator for Nine Star Ki profile calculation.
 * Handles user input, validation, and displays results.
 *
 * This is a client component to handle form interactivity.
 */

'use client'

import { useState, useEffect } from 'react'
import type { NineStarKiProfile } from '@/types'
import { calculateProfile, validateInput } from '@/lib/calculator'
import { validateDateString } from '@/lib/utils/date-utils'
import { getLiChunForYear, getSolarTermsForYear } from '@/lib/data/solar-terms-data'
import ProfileResult from './ProfileResult'

interface ProximityWarning {
  level: 'safe' | 'caution' | 'high'
  message: string
  term: string
  hours: number
  minutes: number
  direction: 'before' | 'after'
}

export default function Calculator() {
  // Form state
  const [birthDate, setBirthDate] = useState('')
  const [birthTime, setBirthTime] = useState('')
  const [timezone, setTimezone] = useState('UTC')
  const [error, setError] = useState<string | null>(null)
  const [profile, setProfile] = useState<NineStarKiProfile | null>(null)
  const [isCalculating, setIsCalculating] = useState(false)
  const [proximityWarning, setProximityWarning] = useState<ProximityWarning | null>(null)

  /**
   * Check proximity to solar term boundaries in real-time
   */
  useEffect(() => {
    if (!birthDate) {
      setProximityWarning(null)
      return
    }

    const dateValidation = validateDateString(birthDate)
    if (!dateValidation.isValid || !dateValidation.date) {
      setProximityWarning(null)
      return
    }

    const date = dateValidation.date
    const timeToUse = birthTime || '12:00'

    try {
      // Parse the date/time
      const [hours, minutes] = timeToUse.split(':').map(Number)
      const localDateTime = new Date(date)
      localDateTime.setHours(hours, minutes, 0, 0)

      const year = localDateTime.getFullYear()
      const threeDaysMs = 3 * 24 * 60 * 60 * 1000

      // Check Li Chun
      const liChunDate = getLiChunForYear(year)
      const liChunDiffMs = localDateTime.getTime() - liChunDate.getTime()
      const liChunDiffAbs = Math.abs(liChunDiffMs)

      if (liChunDiffAbs <= threeDaysMs) {
        const totalMinutes = Math.floor(liChunDiffAbs / (60 * 1000))
        const hours = Math.floor(totalMinutes / 60)
        const mins = totalMinutes % 60
        const direction: 'before' | 'after' = liChunDiffMs < 0 ? 'before' : 'after'

        let level: 'safe' | 'caution' | 'high' = 'safe'
        if (hours <= 24) level = 'high'
        else if (hours <= 72) level = 'caution'

        setProximityWarning({
          level,
          message: `Distance to Li Chun: ${hours} hour${hours !== 1 ? 's' : ''} ${mins} minute${mins !== 1 ? 's' : ''} ${direction}`,
          term: 'Li Chun',
          hours,
          minutes: mins,
          direction,
        })
        return
      }

      // Check other solar terms
      const solarYear = localDateTime < liChunDate ? year - 1 : year
      const terms = getSolarTermsForYear(solarYear)
      const majorTerms = [
        { name: 'Jing Zhe', date: terms.jingZhe },
        { name: 'Qing Ming', date: terms.qingMing },
        { name: 'Li Xia', date: terms.liXia },
        { name: 'Mang Zhong', date: terms.mangZhong },
        { name: 'Xiao Shu', date: terms.xiaoShu },
        { name: 'Li Qiu', date: terms.liQiu },
        { name: 'Bai Lu', date: terms.baiLu },
        { name: 'Han Lu', date: terms.hanLu },
        { name: 'Li Dong', date: terms.liDong },
        { name: 'Da Xue', date: terms.daXue },
        { name: 'Xiao Han', date: terms.xiaoHan },
      ]

      for (const term of majorTerms) {
        const termDiffMs = localDateTime.getTime() - term.date.getTime()
        const termDiffAbs = Math.abs(termDiffMs)

        if (termDiffAbs <= threeDaysMs) {
          const totalMinutes = Math.floor(termDiffAbs / (60 * 1000))
          const hours = Math.floor(totalMinutes / 60)
          const mins = totalMinutes % 60
          const direction: 'before' | 'after' = termDiffMs < 0 ? 'before' : 'after'

          let level: 'safe' | 'caution' | 'high' = 'safe'
          if (hours <= 24) level = 'high'
          else if (hours <= 72) level = 'caution'

          setProximityWarning({
            level,
            message: `Distance to ${term.name}: ${hours} hour${hours !== 1 ? 's' : ''} ${mins} minute${mins !== 1 ? 's' : ''} ${direction}`,
            term: term.name,
            hours,
            minutes: mins,
            direction,
          })
          return
        }
      }

      setProximityWarning(null)
    } catch {
      setProximityWarning(null)
    }
  }, [birthDate, birthTime])

  /**
   * Handle form submission
   */
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    setError(null)
    setProfile(null)

    // Validate date string
    const dateValidation = validateDateString(birthDate)
    if (!dateValidation.isValid) {
      setError(dateValidation.error || 'Invalid date')
      return
    }

    if (!dateValidation.date) {
      setError('Unable to parse date')
      return
    }

    // Use default time of 12:00 (noon) if not provided
    const timeToUse = birthTime || '12:00'

    // Validate calculation input
    const inputValidation = validateInput({
      date: dateValidation.date,
      time: timeToUse,
      timezone: timezone
    })
    if (!inputValidation.isValid) {
      setError(inputValidation.error || 'Invalid input')
      return
    }

    // Calculate profile
    setIsCalculating(true)
    try {
      const calculatedProfile = calculateProfile({
        date: dateValidation.date,
        time: timeToUse,
        timezone: timezone
      })
      setProfile(calculatedProfile)
    } catch (err) {
      setError(
        err instanceof Error
          ? err.message
          : 'An error occurred during calculation. Please try again.'
      )
    } finally {
      setIsCalculating(false)
    }
  }

  /**
   * Handle input change
   */
  const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setBirthDate(e.target.value)
    // Clear error when user starts typing
    if (error) setError(null)
  }

  /**
   * Reset calculator
   */
  const handleReset = () => {
    setBirthDate('')
    setBirthTime('')
    setTimezone('UTC')
    setError(null)
    setProfile(null)
  }

  return (
    <div className="space-y-8">
      {/* Calculator form */}
      <div className="card">
        <h2 className="mb-6 font-serif text-2xl font-medium text-sumi-900">
          Calculate Your Profile
        </h2>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Date input */}
          <div>
            <label htmlFor="birthDate" className="label">
              Birth Date
            </label>
            <input
              type="date"
              id="birthDate"
              value={birthDate}
              onChange={handleDateChange}
              className="input"
              placeholder="YYYY-MM-DD"
              required
              max={new Date().toISOString().split('T')[0]} // Prevent future dates
              min="1900-01-01"
            />
            <p className="mt-2 text-sm text-sumi-500">
              Enter your birth date. The calculator uses the solar calendar with Li Chun
              adjustments.
            </p>
          </div>

          {/* Time input */}
          <div>
            <label htmlFor="birthTime" className="label">
              Birth Time <span className="text-sumi-400">(optional)</span>
            </label>
            <input
              type="time"
              id="birthTime"
              value={birthTime}
              onChange={(e) => setBirthTime(e.target.value)}
              className="input"
            />
            <p className="mt-2 text-sm text-sumi-500">
              Optional. Defaults to 12:00 (noon) if not provided. For dates near solar term boundaries
              (Feb 3-5 or around the 5th-8th of each month), the exact birth time may affect your results.
            </p>

            {/* Real-time proximity warning */}
            {proximityWarning && (
              <div
                className={`mt-3 animate-slide-up rounded-lg border-2 p-3 ${
                  proximityWarning.level === 'high'
                    ? 'border-shu-300 bg-shu-50'
                    : proximityWarning.level === 'caution'
                      ? 'border-yellow-300 bg-yellow-50'
                      : 'border-green-300 bg-green-50'
                }`}
              >
                <div className="flex items-start gap-2">
                  <div className="flex-shrink-0">
                    {proximityWarning.level === 'high' ? (
                      <svg
                        className="h-5 w-5 text-shu-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        />
                      </svg>
                    ) : proximityWarning.level === 'caution' ? (
                      <svg
                        className="h-5 w-5 text-yellow-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    ) : (
                      <svg
                        className="h-5 w-5 text-green-600"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                    )}
                  </div>
                  <div className="flex-1">
                    <p
                      className={`text-sm font-semibold ${
                        proximityWarning.level === 'high'
                          ? 'text-shu-900'
                          : proximityWarning.level === 'caution'
                            ? 'text-yellow-900'
                            : 'text-green-900'
                      }`}
                    >
                      {proximityWarning.level === 'high'
                        ? 'Near ' + proximityWarning.term + ' boundary - Time precision matters!'
                        : proximityWarning.level === 'caution'
                          ? 'Approaching ' + proximityWarning.term + ' boundary'
                          : 'Close to ' + proximityWarning.term + ' boundary'}
                    </p>
                    <p
                      className={`mt-1 text-xs ${
                        proximityWarning.level === 'high'
                          ? 'text-shu-700'
                          : proximityWarning.level === 'caution'
                            ? 'text-yellow-700'
                            : 'text-green-700'
                      }`}
                    >
                      {proximityWarning.message}
                    </p>
                    {proximityWarning.level !== 'safe' && (
                      <p
                        className={`mt-1 text-xs italic ${
                          proximityWarning.level === 'high'
                            ? 'text-shu-600'
                            : 'text-yellow-600'
                        }`}
                      >
                        {proximityWarning.level === 'high'
                          ? 'Please enter your exact birth time if known.'
                          : 'Verify your birth time if possible for best accuracy.'}
                      </p>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Timezone selector */}
          <div>
            <label htmlFor="timezone" className="label">
              Timezone <span className="text-sumi-400">(optional)</span>
            </label>
            <select
              id="timezone"
              value={timezone}
              onChange={(e) => setTimezone(e.target.value)}
              className="input"
            >
              <option value="UTC">UTC</option>

              <optgroup label="Americas - North">
                <option value="America/New_York">Eastern Time (New York)</option>
                <option value="America/Chicago">Central Time (Chicago)</option>
                <option value="America/Denver">Mountain Time (Denver)</option>
                <option value="America/Phoenix">Mountain Time - Arizona (Phoenix)</option>
                <option value="America/Los_Angeles">Pacific Time (Los Angeles)</option>
                <option value="America/Anchorage">Alaska Time (Anchorage)</option>
                <option value="Pacific/Honolulu">Hawaii Time (Honolulu)</option>
                <option value="America/Toronto">Toronto</option>
                <option value="America/Vancouver">Vancouver</option>
                <option value="America/Montreal">Montreal</option>
                <option value="America/Edmonton">Calgary/Edmonton</option>
                <option value="America/Halifax">Halifax</option>
                <option value="America/Winnipeg">Winnipeg</option>
              </optgroup>

              <optgroup label="Caribbean & British Territories">
                <option value="Atlantic/Bermuda">Bermuda</option>
                <option value="America/Jamaica">Jamaica</option>
                <option value="America/Barbados">Barbados</option>
                <option value="America/St_Lucia">St. Lucia</option>
                <option value="America/Cayman">Cayman Islands</option>
                <option value="America/Tortola">British Virgin Islands</option>
                <option value="America/Anguilla">Anguilla</option>
                <option value="America/Antigua">Antigua and Barbuda</option>
                <option value="America/Montserrat">Montserrat</option>
                <option value="America/Grand_Turk">Turks and Caicos</option>
                <option value="America/Dominica">Dominica</option>
                <option value="America/Grenada">Grenada</option>
                <option value="America/Port_of_Spain">Trinidad and Tobago</option>
                <option value="America/Nassau">Bahamas</option>
                <option value="America/Aruba">Aruba</option>
                <option value="America/Curacao">Curaçao</option>
                <option value="Atlantic/Stanley">Falkland Islands</option>
                <option value="Europe/Gibraltar">Gibraltar</option>
                <option value="Atlantic/St_Helena">Saint Helena</option>
              </optgroup>

              <optgroup label="Americas - Central & South">
                <option value="America/Mexico_City">Mexico City</option>
                <option value="America/Buenos_Aires">Buenos Aires</option>
                <option value="America/Sao_Paulo">São Paulo</option>
                <option value="America/Lima">Lima</option>
                <option value="America/Bogota">Bogotá</option>
                <option value="America/Santiago">Santiago</option>
                <option value="America/Caracas">Caracas</option>
              </optgroup>

              <optgroup label="Europe">
                <option value="Europe/London">London</option>
                <option value="Europe/Paris">Paris</option>
                <option value="Europe/Berlin">Berlin</option>
                <option value="Europe/Rome">Rome</option>
                <option value="Europe/Madrid">Madrid</option>
                <option value="Europe/Amsterdam">Amsterdam</option>
                <option value="Europe/Brussels">Brussels</option>
                <option value="Europe/Stockholm">Stockholm</option>
                <option value="Europe/Vienna">Vienna</option>
                <option value="Europe/Prague">Prague</option>
                <option value="Europe/Warsaw">Warsaw</option>
                <option value="Europe/Athens">Athens</option>
                <option value="Europe/Istanbul">Istanbul</option>
                <option value="Europe/Moscow">Moscow</option>
              </optgroup>

              <optgroup label="Africa">
                <option value="Africa/Cairo">Cairo</option>
                <option value="Africa/Johannesburg">Johannesburg</option>
                <option value="Africa/Lagos">Lagos</option>
                <option value="Africa/Nairobi">Nairobi</option>
                <option value="Africa/Casablanca">Casablanca</option>
              </optgroup>

              <optgroup label="Middle East">
                <option value="Asia/Dubai">Dubai</option>
                <option value="Asia/Tel_Aviv">Tel Aviv</option>
                <option value="Asia/Riyadh">Riyadh</option>
                <option value="Asia/Tehran">Tehran</option>
              </optgroup>

              <optgroup label="Asia">
                <option value="Asia/Tokyo">Tokyo</option>
                <option value="Asia/Shanghai">Shanghai</option>
                <option value="Asia/Hong_Kong">Hong Kong</option>
                <option value="Asia/Singapore">Singapore</option>
                <option value="Asia/Bangkok">Bangkok</option>
                <option value="Asia/Kolkata">Mumbai/Delhi</option>
                <option value="Asia/Seoul">Seoul</option>
                <option value="Asia/Taipei">Taipei</option>
                <option value="Asia/Manila">Manila</option>
                <option value="Asia/Jakarta">Jakarta</option>
                <option value="Asia/Kuala_Lumpur">Kuala Lumpur</option>
              </optgroup>

              <optgroup label="Oceania">
                <option value="Australia/Sydney">Sydney</option>
                <option value="Australia/Melbourne">Melbourne</option>
                <option value="Pacific/Auckland">Auckland</option>
                <option value="Australia/Perth">Perth</option>
                <option value="Australia/Brisbane">Brisbane</option>
              </optgroup>
            </select>
            <p className="mt-2 text-sm text-sumi-500">
              Your profile is calculated using your local time zone for accurate solar term
              boundaries.
            </p>
          </div>

          {/* Error message */}
          {error && (
            <div className="animate-slide-up rounded-lg border border-shu-200 bg-shu-50 p-4">
              <p className="text-sm text-shu-800">{error}</p>
            </div>
          )}

          {/* Submit button */}
          <div className="flex space-x-4">
            <button
              type="submit"
              disabled={isCalculating || !birthDate}
              className="btn-primary flex-1"
            >
              {isCalculating ? 'Calculating...' : 'Calculate Profile'}
            </button>

            {profile && (
              <button
                type="button"
                onClick={handleReset}
                className="btn-secondary"
              >
                Reset
              </button>
            )}
          </div>
        </form>
      </div>

      {/* Results */}
      {profile && <ProfileResult profile={profile} birthDate={birthDate} birthTime={birthTime} timezone={timezone} />}
    </div>
  )
}
